<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Digital Marketing Course</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
body{font-family:Arial;background:#eef2f7;text-align:center;padding:40px}
.card{background:white;padding:25px;border-radius:15px;max-width:420px;margin:auto;box-shadow:0 5px 25px rgba(0,0,0,.1)}
h2{color:#2563eb}
.price{font-size:28px;color:green;margin:15px}
button{padding:12px 25px;border:none;border-radius:8px;background:#2563eb;color:white;cursor:pointer;margin:10px}
button:hover{background:#1e40af}
.box{display:none;margin-top:20px}
input{padding:10px;width:85%;margin-top:10px;border-radius:6px;border:1px solid #ccc}
.link a{display:block;background:green;color:white;padding:10px;margin:10px;border-radius:8px;text-decoration:none}
</style>
</head>

<body>

<div class="card">
<h2>Digital Marketing Course</h2>
<div class="price">NPR 299</div>

<button onclick="start()">Buy Now</button>

<div id="step1" class="box">
<h3>Select Payment Method</h3>

<select id="method" onchange="generateQR()">
<option value="">Select Payment</option>
<option value="Khalti">Khalti</option>
<option value="eSewa">eSewa</option>
<option value="Bank">Bank Transfer</option>
</select>

<div id="qrcode" style="margin-top:20px"></div>
<p id="paytext"></p>

<input id="email" placeholder="Your Email">
<input id="txn" placeholder="Transaction ID">
<input id="paid" placeholder="Paid Amount in NPR">

<button onclick="submitPayment()">Submit Payment</button>
</div>

<div id="wait" class="box">
<h3>Payment Submitted ⏳</h3>
<p>Waiting verification...</p>
</div>

<div id="download" class="box">
<h2 style="color:green">Payment Verified ✔</h2>
<p>Your course is ready:</p>
<div class="link">
<a href="https://drive.google.com/">Google Drive</a>
<a href="https://example.com/file.zip">Direct Download</a>
<a href="https://t.me/">Telegram</a>
<a href="mailto:?subject=Digital Marketing Course&body=Download link: https://example.com/file.zip">Send to Email</a>
</div>
</div>

</div>

<script>
const BASE = "https://digital-marketing-course.onrender.com";
const FULL_AMOUNT = 299;

function start(){
document.getElementById("step1").style.display="block";
}

function generateQR(){
const method=document.getElementById("method").value;
const qrDiv=document.getElementById("qrcode");
qrDiv.innerHTML="";

if(!method) return;

let qrData={};

if(method==="Khalti"){
qrData={"Khalti_ID":"9807648317","name":"Ishul Kawari","amount":FULL_AMOUNT};
}
else if(method==="eSewa"){
qrData={"eSewa_id":"9807648317","name":"Ishul Kawari","amount":FULL_AMOUNT};
}
else{
qrData={
"accountNumber":"0315759479191001",
"accountName":"ISHUL KAWARI",
"bankCode":"BOALNPKA",
"bankCodeCIPS":"2301",
"amount":FULL_AMOUNT
};
}

new QRCode(qrDiv,{text:JSON.stringify(qrData),width:200,height:200});

document.getElementById("paytext").innerText =
method==="Bank"
? "Scan QR or transfer NPR 299"
: method+" QR ready. Pay NPR "+FULL_AMOUNT;
}

async function submitPayment(){

const email=document.getElementById("email").value;
const txn=document.getElementById("txn").value;
const paidAmount=parseInt(document.getElementById("paid").value);

if(!email||!txn||isNaN(paidAmount))
return alert("Fill all fields");

if(paidAmount!==FULL_AMOUNT)
return alert("Exact payment must be NPR "+FULL_AMOUNT);

try{

const res=await fetch(BASE+"/submit-payment",{
method:"POST",
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
email,
txn,
paidAmount,
method:document.getElementById("method").value
})
});

const data=await res.json();

if(res.ok){
alert(data.message);
document.getElementById("wait").style.display="block";
}
else alert(data.message);

}catch{
alert("Server connection error");
}
}

setInterval(async ()=>{
const txn=document.getElementById("txn").value;
if(!txn) return;

try{
const res=await fetch(BASE+"/check/"+txn);
const data=await res.json();

if(data.verified)
document.getElementById("download").style.display="block";

}catch{}
},5000);
</script>

  <script>
// ======= Extra enhancements =======

// Reset form fields & QR after submit
const originalSubmitPayment = submitPayment; // backup original function

submitPayment = async function() {
    await originalSubmitPayment(); // call original

    // reset fields and payment selection
    document.getElementById("method").value = "";
    document.getElementById("email").value = "";
    document.getElementById("txn").value = "";
    document.getElementById("paid").value = "";
    document.getElementById("qrcode").innerHTML = "";
    document.getElementById("paytext").innerText = "";
}

// Hide "Waiting Verification..." after admin verified
const waitDiv = document.getElementById("wait");
const downloadDiv = document.getElementById("download");

// Poll verification already exists, just extend it
setInterval(async ()=>{
    const txn = document.getElementById("txn").value.trim();
    if(!txn) return;
    try{
        const res = await fetch(BASE+"/check/"+txn);
        const data = await res.json();
        if(data.verified){
            downloadDiv.style.display = "block";
            waitDiv.style.display = "none"; // hide waiting message automatically
        }
    }catch(e){}
},5000);
  </script>
<script>
// ======= Extra enhancements =======

// Reset form fields & QR after submit
const originalSubmitPayment = submitPayment; // backup original function

submitPayment = async function() {
    await originalSubmitPayment(); // call original

    // reset fields and payment selection
    document.getElementById("method").value = "";
    document.getElementById("email").value = "";
    document.getElementById("txn").value = "";
    document.getElementById("paid").value = "";
    document.getElementById("qrcode").innerHTML = "";
    document.getElementById("paytext").innerText = "";
}

// Hide "Waiting Verification..." after admin verified
const waitDiv = document.getElementById("wait");
const downloadDiv = document.getElementById("download");

// Poll verification already exists, just extend it
setInterval(async ()=>{
    const txn = document.getElementById("txn").value.trim();
    if(!txn) return;
    try{
        const res = await fetch(BASE+"/check/"+txn);
        const data = await res.json();
        if(data.verified){
            downloadDiv.style.display = "block";
            waitDiv.style.display = "none"; // hide waiting message automatically
        }
    }catch(e){}
},5000);
</script>
  
</body>
</html>
